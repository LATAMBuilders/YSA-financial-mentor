<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YSA ‚Äî Financial Discipline Infrastructure</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
<style>
:root {
  --purple: #836EF9;
  --purple-dark: #6B56D6;
  --purple-glow: rgba(131,110,249,0.4);
  --yellow: #F5C518;
  --bg: #0D0D0D;
  --surface: #1A1A2E;
  --dark: #E0E0E0;
  --text: #E0E0E0;
  --text-muted: #888;
  --border: #2A2A3E;
  --cell-bg: #16162A;
  --header-bg: #1E1E36;
  --success: #4CC98A;
  --error: #E84855;
  --glow: rgba(245,197,24,0.6);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* TOP BAR */
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10;}
.topbar-left{display:flex;align-items:center;gap:10px;}
.logo{font-size:24px;font-weight:800;color:var(--purple);letter-spacing:1px;font-family:'Inter',sans-serif;text-shadow:0 0 20px var(--purple-glow);}
.logo-sub{font-size:12px;color:var(--text-muted);font-weight:500;}
.topbar-center{display:flex;align-items:center;gap:10px;}
.connect-btn{background:var(--purple);color:#fff;border:none;padding:8px 20px;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;font-family:'Roboto Mono',monospace;transition:background .2s;}
.connect-btn:hover{background:var(--purple-dark);}
.connect-btn.connected{background:var(--success);}
.demo-btn{background:var(--yellow);color:#0D0D0D;border:none;padding:8px 20px;border-radius:6px;font-weight:700;font-size:13px;cursor:pointer;font-family:'Roboto Mono',monospace;transition:transform .15s;}
.demo-btn:hover{transform:scale(1.03);}
.demo-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.topbar-right{display:flex;align-items:center;gap:14px;font-size:13px;color:var(--text-muted);}
.cycle-badge{padding:4px 10px;border-radius:12px;font-weight:600;font-size:12px;font-family:'Roboto Mono',monospace;background:#2A2A3E;color:var(--text-muted);}
.cycle-badge.active{background:rgba(76,201,138,0.15);color:var(--success);}

/* MAIN LAYOUT */
.main{flex:1;display:flex;overflow:hidden;}

/* LEFT PANEL - CHAT */
.panel-chat{width:25%;min-width:240px;display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--surface);}
.panel-title{padding:12px 16px;font-weight:700;font-size:14px;border-bottom:1px solid var(--border);background:rgba(131,110,249,0.05);color:var(--text);}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.msg{max-width:88%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.5;animation:msgIn .3s ease;display:flex;flex-direction:column;}
.msg.ysa{align-self:flex-start;background:rgba(131,110,249,0.12);color:#D0C8FF;border-bottom-left-radius:4px;border:1px solid rgba(131,110,249,0.2);}
.msg.daniela{align-self:flex-end;background:rgba(245,197,24,0.15);color:var(--yellow);border-bottom-right-radius:4px;border:1px solid rgba(245,197,24,0.2);}
.msg .author{font-weight:700;font-size:11px;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}
.msg.ysa .author{color:var(--purple);}
.msg.daniela .author{color:var(--yellow);}
.ysa-avatar{display:inline-flex;align-items:center;gap:4px;}
.ysa-avatar::before{content:'ü¶Ö';display:inline-block;width:20px;height:20px;line-height:20px;text-align:center;font-size:12px;background:#0D0D0D;border-radius:50%;border:1px solid var(--purple);flex-shrink:0;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.chat-input{padding:10px;border-top:1px solid var(--border);display:flex;gap:6px;}
.chat-input input{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;outline:none;background:var(--bg);color:var(--text);}
.chat-input input:focus{border-color:var(--purple);}
.chat-input button{background:var(--purple);color:#fff;border:none;padding:8px 14px;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;font-family:'Roboto Mono',monospace;}

/* CENTER PANEL - SPREADSHEET */
.panel-excel{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--bg);}
.excel-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface);}
.excel-tab{padding:10px 18px;font-size:13px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-muted);transition:all .15s;}
.excel-tab:hover{color:var(--text);}
.excel-tab.active{color:var(--purple);border-bottom-color:var(--purple);background:var(--bg);}
.excel-container{flex:1;overflow:auto;position:relative;}
.excel-table{width:100%;border-collapse:collapse;font-size:12px;font-family:'Roboto Mono',monospace;}
.excel-table th{background:var(--header-bg);padding:8px 12px;text-align:left;font-weight:600;font-size:11px;color:var(--text-muted);border:1px solid var(--border);position:sticky;top:0;z-index:1;white-space:nowrap;}
.excel-table td{padding:7px 12px;border:1px solid var(--border);background:var(--cell-bg);font-variant-numeric:tabular-nums;transition:background .3s;color:#CCC;}
.excel-table td.number{text-align:right;font-family:'Roboto Mono',monospace;}
.excel-table td.label{font-weight:600;color:var(--text);background:var(--surface);font-family:'Inter',sans-serif;}
.excel-table td.sub-label{padding-left:24px;color:var(--text-muted);font-family:'Inter',sans-serif;}
.excel-table td.total-row{font-weight:700;border-top:2px solid var(--purple);background:rgba(131,110,249,0.08);color:var(--yellow);}
.excel-table tr.section-header td{background:rgba(131,110,249,0.1);font-weight:700;color:var(--purple);font-size:12px;font-family:'Inter',sans-serif;}
@keyframes cellGlow{0%{box-shadow:inset 0 0 0 2px var(--glow);background:rgba(245,197,24,0.15);}50%{box-shadow:inset 0 0 12px 2px var(--glow);background:rgba(245,197,24,0.25);}100%{box-shadow:inset 0 0 0 0 transparent;background:var(--cell-bg);}}
.cell-highlight{animation:cellGlow 1.5s ease;}
.row-nums{color:var(--text-muted);font-size:11px;background:var(--surface) !important;text-align:center;width:30px;}

/* RIGHT PANEL - SIDEBAR */
.panel-sidebar{width:25%;min-width:220px;display:flex;flex-direction:column;background:var(--surface);overflow-y:auto;}
.sidebar-section{padding:16px;border-bottom:1px solid var(--border);}
.sidebar-section h3{font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px;}

/* Progress bars */
.progress-item{margin-bottom:10px;}
.progress-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;color:var(--text-muted);}
.progress-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;border-radius:4px;transition:width .8s ease;background:linear-gradient(90deg,var(--purple),#A78BFA);}
.progress-fill.complete{background:linear-gradient(90deg,var(--success),#6EE7B7);}
.progress-check{color:var(--success);font-weight:700;}

/* Badges */
.badge-list{display:flex;flex-direction:column;gap:8px;}
.badge-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;font-size:13px;font-weight:600;transition:all .2s;}
.badge-item.locked{opacity:.45;color:var(--text-muted);}
.badge-item.current{background:rgba(245,197,24,0.1);border:1px solid rgba(245,197,24,0.3);color:var(--yellow);}
.badge-item.earned{background:rgba(76,201,138,0.1);color:var(--success);}
.badge-icon{font-size:18px;}
.badge-level{font-size:11px;color:var(--text-muted);font-weight:500;}

/* Quiz */
.sidebar-section.quiz-section{background:rgba(131,110,249,0.04);border-left:3px solid var(--purple);}
.quiz-score{font-size:12px;color:var(--purple);font-weight:600;margin-bottom:10px;font-family:'Roboto Mono',monospace;}
.quiz-q{margin-bottom:14px;}
.quiz-q .q-text{font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text);}
.quiz-q .q-options{display:flex;flex-direction:column;gap:4px;}
.quiz-q .q-opt{padding:6px 10px;font-size:12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;background:var(--bg);color:var(--text);}
.quiz-q .q-opt:hover{background:rgba(131,110,249,0.1);border-color:var(--purple);}
.quiz-q .q-opt.correct{background:rgba(76,201,138,0.15);border-color:var(--success);color:var(--success);}
.quiz-q .q-opt.wrong{background:rgba(232,72,85,0.15);border-color:var(--error);color:var(--error);}
.quiz-q .q-opt.disabled{pointer-events:none;opacity:.7;}

/* Footer */
.footer{height:32px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text-muted);flex-shrink:0;gap:8px;}
.monad-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;background:rgba(131,110,249,0.1);border:1px solid rgba(131,110,249,0.25);color:var(--purple);font-weight:600;font-size:11px;font-family:'Roboto Mono',monospace;box-shadow:0 0 12px rgba(131,110,249,0.15);}

/* RESPONSIVE */
@media(max-width:900px){
  .main{flex-direction:column;overflow-y:auto;}
  .panel-chat,.panel-sidebar{width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--border);}
  .panel-chat{max-height:40vh;}
  .panel-excel{min-height:50vh;}
  .panel-sidebar{max-height:none;}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#333;border-radius:3px;}

/* Demo Timer */
.demo-timer{display:none;background:var(--surface);border-bottom:1px solid var(--border);padding:6px 20px;align-items:center;gap:12px;font-size:12px;color:var(--text-muted);font-family:'Roboto Mono',monospace;}
.demo-timer.active{display:flex;}
.demo-timer-bar{flex:1;height:4px;background:#2A2A3E;border-radius:2px;overflow:hidden;}
.demo-timer-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--yellow));border-radius:2px;width:0%;transition:width 0.3s;}
.demo-timer-text{min-width:80px;text-align:right;}

/* Confetti */
.confetti-piece{position:fixed;width:10px;height:10px;top:-10px;z-index:9999;animation:confetti-fall 3s ease-in forwards;}
@keyframes confetti-fall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}

/* Badge unlock glow */
.badge-item.unlocked{background:rgba(131,110,249,0.15);border:1px solid var(--purple);animation:badge-glow 1s ease;}
@keyframes badge-glow{0%{box-shadow:0 0 20px var(--purple-glow);}100%{box-shadow:none;}}

/* Staking notification */
.stake-notification{position:fixed;bottom:20px;right:20px;background:var(--surface);border:1px solid var(--purple);border-radius:12px;padding:16px 24px;z-index:9998;font-size:14px;animation:slide-up 0.5s ease;box-shadow:0 4px 24px rgba(0,0,0,0.5);}
.stake-notification .stake-amount{font-size:24px;font-weight:800;color:var(--yellow);font-family:'Roboto Mono',monospace;}
@keyframes slide-up{from{transform:translateY(100px);opacity:0;}to{transform:translateY(0);opacity:1;}}
</style>
</head>
<body>

<!-- DEMO TIMER -->
<div class="demo-timer" id="demoTimer">
  <span>üé¨ DEMO</span>
  <div class="demo-timer-bar"><div class="demo-timer-fill" id="demoTimerFill"></div></div>
  <div class="demo-timer-text" id="demoTimerText">0:00 / 1:30</div>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <div style="font-size:32px;line-height:1;">ü¶Ö</div>
    <div class="logo">YSA</div>
    <span class="logo-sub">Financial Mentor</span>
  </div>
  <div class="topbar-center">
    <button class="demo-btn" id="demoBtn" onclick="startDemo()">‚ñ∂ Watch Demo</button>
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">ü¶ä Connect Wallet</button>
  </div>
  <div class="topbar-right">
    <span class="cycle-badge" id="cycleBadge">Not started</span>
    <span id="monBalance"></span>
    <span style="display:flex;align-items:center;gap:4px;font-weight:600;color:#836EF9;font-size:13px;"><img src="https://monad.xyz/favicon.ico" alt="Monad" style="width:18px;height:18px;border-radius:50%;"> Monad</span>
  </div>
</div>

<!-- MAIN 3-PANEL -->
<div class="main">

  <!-- LEFT: CHAT -->
  <div class="panel-chat">
    <div class="panel-title">üí¨ Chat with Ysa</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type your answer..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">Send</button>
    </div>
  </div>

  <!-- CENTER: EXCEL -->
  <div class="panel-excel">
    <div class="excel-tabs">
      <div class="excel-tab active" data-tab="pl" onclick="switchTab('pl')">üìä Estado de Resultados</div>
      <div class="excel-tab" data-tab="cf" onclick="switchTab('cf')">üí∞ Cash Flow</div>
      <div class="excel-tab" data-tab="bs" onclick="switchTab('bs')">üìã Balance Sheet</div>
    </div>
    <div class="excel-container" id="excelContainer"></div>
  </div>

  <!-- RIGHT: SIDEBAR -->
  <div class="panel-sidebar">
    <div class="sidebar-section">
      <h3>üìÑ Document Progress</h3>
      <div class="progress-item">
        <div class="progress-label"><span>Estado de Resultados</span><span id="plPct">0%</span></div>
        <div class="progress-bar"><div class="progress-fill" id="plBar" style="width:0%"></div></div>
      </div>
      <div class="progress-item">
        <div class="progress-label"><span>Cash Flow</span><span id="cfPct">0%</span></div>
        <div class="progress-bar"><div class="progress-fill" id="cfBar" style="width:0%"></div></div>
      </div>
      <div class="progress-item">
        <div class="progress-label"><span>Balance Sheet</span><span id="bsPct">0%</span></div>
        <div class="progress-bar"><div class="progress-fill" id="bsBar" style="width:0%"></div></div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>üèÜ Level & Badges</h3>
      <div class="badge-list" id="badgeList">
        <div class="badge-item current" data-level="1"><span class="badge-icon">üìã</span><div><div>Level 1: Organized</div><div class="badge-level">Basic records</div></div></div>
        <div class="badge-item locked" data-level="2"><span class="badge-icon">üîí</span><div><div>Level 2: Disciplined</div><div class="badge-level">Cycle completed</div></div></div>
        <div class="badge-item locked" data-level="3"><span class="badge-icon">üîí</span><div><div>Level 3: Capital Ready</div><div class="badge-level">Projections ready</div></div></div>
        <div class="badge-item locked" data-level="4"><span class="badge-icon">üîí</span><div><div>Level 4: Investor Grade</div><div class="badge-level">Documents complete</div></div></div>
      </div>
    </div>

    <div class="sidebar-section quiz-section">
      <h3>üß† Daily Quiz</h3>
      <div class="quiz-score" id="quizScore">0/3 completed today</div>
      <div id="quizContainer"></div>
    </div>
  </div>

</div>

<div class="footer"><span class="monad-badge">üü£ Built on Monad</span><span>YSA Financial Mentor v2.0</span></div>

<script>
// ============ CONTRACT CONFIG ============
const CONTRACTS = {
  discipline: "0x0000000000000000000000000000000000000000",
  badge:      "0x0000000000000000000000000000000000000000",
  grantPool:  "0x0000000000000000000000000000000000000000"
};
const MONAD = {
  chainId: "0x27A7",
  chainName: "Monad Testnet",
  rpcUrls: ["https://testnet-rpc.monad.xyz"],
  nativeCurrency: { name:"MON", symbol:"MON", decimals:18 },
  blockExplorerUrls: ["https://testnet.monadexplorer.com"]
};
const DISCIPLINE_ABI = [
  "function stake() payable",
  "function getCycleInfo(address) view returns (uint256,uint8,bool,bool,uint256)",
  "function completeChallenge(address)",
  "function completeCycle(address)",
  "function slash(address)"
];
const BADGE_ABI = [
  "function levelOf(address) view returns (uint8)"
];
const POOL_ABI = [
  "function deposit() payable",
  "function getPool(uint256) view returns (address,string,uint256,uint256,bool)"
];

let provider, signer, userAddress;

// ============ WALLET ============
async function connectWallet() {
  if (!window.ethereum) return alert("Install MetaMask");
  try {
    await window.ethereum.request({ method:"eth_requestAccounts" });
    try {
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:MONAD.chainId}] });
    } catch(e) {
      if (e.code===4902) await window.ethereum.request({ method:"wallet_addEthereumChain", params:[MONAD] });
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    const btn = document.getElementById("connectBtn");
    btn.textContent = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
    btn.classList.add("connected");
    const bal = await provider.getBalance(userAddress);
    document.getElementById("monBalance").textContent = parseFloat(ethers.formatEther(bal)).toFixed(2)+" MON";
    document.getElementById("cycleBadge").textContent = "Activo";
    document.getElementById("cycleBadge").classList.add("active");
  } catch(e) { console.error(e); }
}

// ============ SPREADSHEET DATA ============
const months = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

const plData = {
  headers: ["","Mes 1","Mes 2","Mes 3","Mes 4","Mes 5","Mes 6","Mes 7","Mes 8","Mes 9","Mes 10","Mes 11","Mes 12"],
  rows: [
    {type:"section",label:"INGRESOS"},
    {id:"revenue",label:"Revenue",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"other_rev",label:"Other income",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"total_rev",label:"Total Revenue",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {type:"section",label:"COSTO DE VENTAS"},
    {id:"cogs",label:"COGS",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"gross_profit",label:"Gross Profit",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {id:"gross_margin",label:"Gross Margin %",values:["","","","","","","","","","","",""],fmt:"%"},
    {type:"section",label:"GASTOS OPERATIVOS"},
    {id:"rent",label:"Rent",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"salaries",label:"Payroll",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"marketing",label:"Marketing",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"utilities",label:"Utilities",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"other_exp",label:"Other expenses",values:["","","","","","","","","","","",""],fmt:"$",sub:true},
    {id:"total_opex",label:"Total OpEx",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {type:"section",label:"RESULTADO"},
    {id:"ebitda",label:"EBITDA",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {id:"net_margin",label:"Net Margin %",values:["","","","","","","","","","","",""],fmt:"%"},
  ]
};

const cfData = {
  headers: ["","Mes 1","Mes 2","Mes 3","Mes 4","Mes 5","Mes 6","Mes 7","Mes 8","Mes 9","Mes 10","Mes 11","Mes 12"],
  rows: [
    {type:"section",label:"ENTRADAS DE EFECTIVO"},
    {id:"cf_sales",label:"Cobros por ventas",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"cf_other",label:"Other income",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"cf_total_in",label:"Total Entradas",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {type:"section",label:"SALIDAS DE EFECTIVO"},
    {id:"cf_cogs",label:"Pago proveedores",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"cf_opex",label:"Operating expenses",values:["","","","","","","","","","","",""],fmt:"$"},
    {id:"cf_total_out",label:"Total Salidas",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {type:"section",label:"FLUJO NETO"},
    {id:"cf_net",label:"Net Monthly Cash Flow",values:["","","","","","","","","","","",""],fmt:"$",total:true},
    {id:"cf_cumulative",label:"Cumulative Cash Flow",values:["","","","","","","","","","","",""],fmt:"$",total:true},
  ]
};

const bsData = {
  headers: ["","Mes 1","Mes 6","Mes 12"],
  rows: [
    {type:"section",label:"ACTIVOS"},
    {id:"bs_cash",label:"Cash",values:["","",""],fmt:"$"},
    {id:"bs_inventory",label:"Inventory",values:["","",""],fmt:"$"},
    {id:"bs_ar",label:"Accounts receivable",values:["","",""],fmt:"$"},
    {id:"bs_equipment",label:"Equipment",values:["","",""],fmt:"$"},
    {id:"bs_total_a",label:"Total Assets",values:["","",""],fmt:"$",total:true},
    {type:"section",label:"PASIVOS"},
    {id:"bs_ap",label:"Accounts payable",values:["","",""],fmt:"$"},
    {id:"bs_loans",label:"Loans",values:["","",""],fmt:"$"},
    {id:"bs_total_l",label:"Total Liabilities",values:["","",""],fmt:"$",total:true},
    {type:"section",label:"CAPITAL"},
    {id:"bs_equity",label:"Equity",values:["","",""],fmt:"$",total:true},
  ]
};

const tabSheets = { pl: plData, cf: cfData, bs: bsData };
let currentTab = "pl";

function renderSheet(tabKey) {
  const data = tabSheets[tabKey];
  const container = document.getElementById("excelContainer");
  let html = '<table class="excel-table"><thead><tr>';
  data.headers.forEach((h,i) => {
    html += `<th>${i===0?'':h}</th>`;
  });
  html += '</tr></thead><tbody>';
  let rowNum = 1;
  data.rows.forEach(row => {
    if (row.type === "section") {
      html += `<tr class="section-header"><td colspan="${data.headers.length}">${row.label}</td></tr>`;
    } else {
      html += '<tr>';
      html += `<td class="${row.total?'label total-row':row.sub?'sub-label':'label'}">${row.label}</td>`;
      row.values.forEach((v,ci) => {
        const cls = [row.total?'number total-row':'number'];
        const cellId = `${tabKey}_${row.id}_${ci}`;
        html += `<td class="${cls.join(' ')}" id="${cellId}">${v?formatVal(v,row.fmt):''}</td>`;
      });
      html += '</tr>';
      rowNum++;
    }
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function formatVal(v, fmt) {
  if (fmt === '%') return (typeof v==='number'? v.toFixed(2)+'%' : v);
  if (fmt === '$') return (typeof v==='number'? '$'+v.toLocaleString('en-US',{minimumFractionDigits:0}) : v);
  return v;
}

function setCellValue(tabKey, rowId, colIdx, value, fmt) {
  const data = tabSheets[tabKey];
  const row = data.rows.find(r => r.id === rowId);
  if (row) row.values[colIdx] = value;
  if (currentTab === tabKey) {
    const cellId = `${tabKey}_${rowId}_${colIdx}`;
    const el = document.getElementById(cellId);
    if (el) {
      el.textContent = formatVal(value, fmt||'$');
      el.classList.remove('cell-highlight');
      void el.offsetWidth;
      el.classList.add('cell-highlight');
    }
  }
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.excel-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
  renderSheet(tab);
}

// ============ PROGRESS ============
function setProgress(doc, pct) {
  const bar = document.getElementById(doc+'Bar');
  const label = document.getElementById(doc+'Pct');
  bar.style.width = pct+'%';
  label.textContent = pct+'%';
  if (pct >= 100) bar.classList.add('complete');
}

// ============ CHAT ============
function addMessage(who, text) {
  const container = document.getElementById("chatMessages");
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.innerHTML = `<div class="author">${who==='ysa'?'<span class="ysa-avatar">YSA</span>':'Daniela'}</div>${text}`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function sendChat() {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;
  addMessage("daniela", text);
  input.value = "";
}

// ============ QUIZ ============
const allQuizzes = [
  {q:"What does a 32% gross margin indicate?",opts:["For every $100 in sales, $32 is gross profit","The business loses 32%","Costs are 32% of the price"],correct:0},
  {q:"What's the difference between cash flow and P&L?",opts:["Cash flow measures actual cash; P&L includes accruals","They're the same in different format","Cash flow only measures income"],correct:0},
  {q:"If your COGS rises 10% and you don't adjust prices, what happens?",opts:["Your gross margin drops","Your revenue goes up","Nothing if you sell more"],correct:0},
  {q:"What is EBITDA?",opts:["Earnings before interest, taxes, depreciation & amortization","Total operating expenses","Net profit after taxes"],correct:0},
  {q:"Why is break-even point important?",opts:["It tells you how much you need to sell to cover costs","It's the maximum price you can charge","It defines your ideal profit margin"],correct:0},
  {q:"What if your cash flow is negative but you have profit?",opts:["You can run out of cash to operate","Impossible, they're always equal","It means your business is profitable"],correct:0},
  {q:"A 32% gross margin in food is:",opts:["Acceptable but tight for scaling","Excellent, no improvement needed","Very low, you should close"],correct:0},
  {q:"What are accounts receivable?",opts:["Money your customers owe you","Money you owe to suppliers","Cash in the bank"],correct:0},
  {q:"If rent is fixed and you sell more, what happens to net margin?",opts:["It improves because you dilute fixed costs","It gets worse with more volume","It doesn't change"],correct:0},
];

let quizSet = 0;
let quizCorrect = 0;

function renderQuiz() {
  const container = document.getElementById("quizContainer");
  const start = quizSet * 3;
  const qs = allQuizzes.slice(start, start+3);
  if (qs.length === 0) { container.innerHTML = '<p style="font-size:13px;color:#27ae60;">üéâ All completed!</p>'; return; }
  container.innerHTML = qs.map((q,i) => {
    const qi = start+i;
    return `<div class="quiz-q" id="qq${qi}">
      <div class="q-text">${i+1}. ${q.q}</div>
      <div class="q-options">${q.opts.map((o,oi) =>
        `<div class="q-opt" onclick="answerQuiz(${qi},${oi})">${String.fromCharCode(97+oi)}) ${o}</div>`
      ).join('')}</div>
    </div>`;
  }).join('');
}

function answerQuiz(qi, oi) {
  const q = allQuizzes[qi];
  const el = document.getElementById('qq'+qi);
  const opts = el.querySelectorAll('.q-opt');
  opts.forEach((o,i) => {
    o.classList.add('disabled');
    if (i===q.correct) o.classList.add('correct');
    else if (i===oi && oi!==q.correct) o.classList.add('wrong');
  });
  if (oi===q.correct) quizCorrect++;
  document.getElementById("quizScore").textContent = `${quizCorrect}/3 completed today`;
  if (quizCorrect === 3) {
    setTimeout(() => { quizSet++; quizCorrect=0; document.getElementById("quizScore").textContent="0/3 completed today"; renderQuiz(); }, 1500);
  }
}

// ============ DEMO AUTO-PLAY ============
const demoScript = [
  {type:"msg",who:"ysa",text:"Hi Daniela. Let's get straight to it. How much do you invoice per month at Hummus M√°shu?"},
  {type:"msg",who:"daniela",text:"Between 80 and 100 thousand pesos"},
  {type:"msg",who:"ysa",text:"Between 80 and 100 is not a number. How much <b>exactly</b> last month?"},
  {type:"msg",who:"daniela",text:"Last month it was $95,400"},
  {type:"data",tab:"pl",row:"revenue",col:0,val:95400,fmt:"$"},
  {type:"progress",doc:"pl",pct:8},
  {type:"msg",who:"ysa",text:"Good. And how much did it cost to produce that? Give me the full COGS."},
  {type:"msg",who:"daniela",text:"About $64,800 in raw materials and production"},
  {type:"data",tab:"pl",row:"cogs",col:0,val:64800,fmt:"$"},
  {type:"data",tab:"pl",row:"gross_profit",col:0,val:30600,fmt:"$"},
  {type:"data",tab:"pl",row:"gross_margin",col:0,val:32.08,fmt:"%"},
  {type:"progress",doc:"pl",pct:15},
  {type:"msg",who:"ysa",text:"Gross margin: 32%. Not bad for food. But not enough to scale. We need to break down your operating expenses."},
  {type:"msg",who:"daniela",text:"Ok, rent is $4,500, payroll $3,200, marketing $800, utilities $700, and other $500"},
  {type:"data",tab:"pl",row:"rent",col:0,val:4500,fmt:"$"},
  {type:"data",tab:"pl",row:"salaries",col:0,val:3200,fmt:"$"},
  {type:"data",tab:"pl",row:"marketing",col:0,val:800,fmt:"$"},
  {type:"data",tab:"pl",row:"utilities",col:0,val:700,fmt:"$"},
  {type:"data",tab:"pl",row:"other_exp",col:0,val:500,fmt:"$"},
  {type:"data",tab:"pl",row:"total_opex",col:0,val:9700,fmt:"$"},
  {type:"progress",doc:"pl",pct:35},
  {type:"msg",who:"ysa",text:"Operating expenses: $9,700. Your EBITDA is $20,900. Net margin ~22%. Now tell me: is this consistent month to month?"},
  {type:"data",tab:"pl",row:"ebitda",col:0,val:20900,fmt:"$"},
  {type:"data",tab:"pl",row:"net_margin",col:0,val:21.90,fmt:"%"},
  {type:"data",tab:"pl",row:"total_rev",col:0,val:95400,fmt:"$"},
  {type:"msg",who:"daniela",text:"More or less. January was $85,200 and February $88,000. It's been growing."},
  // Fill months 2-6 revenue
  {type:"data",tab:"pl",row:"revenue",col:1,val:88000,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:2,val:90500,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:3,val:92100,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:4,val:93800,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:5,val:95400,fmt:"$"},
  {type:"progress",doc:"pl",pct:50},
  {type:"msg",who:"ysa",text:"3-4% monthly growth. Modest but solid. Let's project the next 6 months keeping that trend."},
  // Months 7-12 revenue projection
  {type:"data",tab:"pl",row:"revenue",col:6,val:97500,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:7,val:99800,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:8,val:101500,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:9,val:103200,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:10,val:105000,fmt:"$"},
  {type:"data",tab:"pl",row:"revenue",col:11,val:107000,fmt:"$"},
  {type:"progress",doc:"pl",pct:70},
  {type:"msg",who:"ysa",text:"Now COGS for each month. If you maintain 68%, these are your projected costs."},
  {type:"data",tab:"pl",row:"cogs",col:1,val:59840,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:2,val:61540,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:3,val:62628,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:4,val:63784,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:5,val:64872,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:6,val:66300,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:7,val:67864,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:8,val:69020,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:9,val:70176,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:10,val:71400,fmt:"$"},
  {type:"data",tab:"pl",row:"cogs",col:11,val:72760,fmt:"$"},
  {type:"progress",doc:"pl",pct:85},
  {type:"msg",who:"ysa",text:"P&L almost complete. Let's move to cash flow. How much cash do you have in the bank today?"},
  {type:"msg",who:"daniela",text:"We have $32,000 in the bank"},
  {type:"data",tab:"cf",row:"cf_sales",col:0,val:95400,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_cogs",col:0,val:64800,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_opex",col:0,val:9700,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_total_in",col:0,val:95400,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_total_out",col:0,val:74500,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_net",col:0,val:20900,fmt:"$"},
  {type:"data",tab:"cf",row:"cf_cumulative",col:0,val:52900,fmt:"$"},
  {type:"progress",doc:"cf",pct:25},
  {type:"progress",doc:"pl",pct:95},
  {type:"msg",who:"ysa",text:"Positive cash flow from month 1. That's a good sign. We need to project 12 months and record your balance sheet. Looking good, Daniela. Your business has solid fundamentals."},
  {type:"data",tab:"bs",row:"bs_cash",col:0,val:32000,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_inventory",col:0,val:8500,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_equipment",col:0,val:45000,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_total_a",col:0,val:85500,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_ap",col:0,val:12000,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_total_l",col:0,val:12000,fmt:"$"},
  {type:"data",tab:"bs",row:"bs_equity",col:0,val:73500,fmt:"$"},
  {type:"progress",doc:"bs",pct:30},
  {type:"progress",doc:"pl",pct:100},
  {type:"msg",who:"ysa",text:"P&L: ‚úÖ complete. Next step: finish cash flow and balance sheet. You're on track for Level 2. Don't slack off."},
  // === STAKING PHASE ===
  {type:"stake",action:"show",text:"üíé Staking 0.01 MON to start 7-day challenge..."},
  {type:"msg",who:"ysa",text:"Now let's make this real. Stake 0.01 MON to commit to completing your financials in 7 days. Skin in the game, Daniela."},
  {type:"msg",who:"daniela",text:"Done. Let's do this."},
  {type:"stake",action:"confirmed",text:"‚úÖ 0.01 MON staked ‚Äî 7 day challenge active"},
  // === COMPLETE CASH FLOW ===
  {type:"msg",who:"ysa",text:"Good. Cash flow projections for months 2-12 based on your growth rate..."},
  {type:"progress",doc:"cf",pct:60},
  {type:"progress",doc:"cf",pct:85},
  {type:"progress",doc:"cf",pct:100},
  {type:"msg",who:"ysa",text:"Cash flow statement: ‚úÖ complete. Two down, one to go."},
  // === COMPLETE BALANCE SHEET ===
  {type:"msg",who:"ysa",text:"Balance sheet ‚Äî assets, liabilities, equity. Let's close this out."},
  {type:"progress",doc:"bs",pct:50},
  {type:"progress",doc:"bs",pct:80},
  {type:"progress",doc:"bs",pct:100},
  // === BADGE UNLOCK ===
  {type:"badge",level:2},
  {type:"confetti"},
  {type:"msg",who:"ysa",text:"All 3 documents complete. üèÜ Badge unlocked: Level 2 ‚Äî Disciplined. Stake returned. You earned it, Daniela. Now let's keep these updated."},
];

let demoRunning = false;
let demoStartTime = 0;
const DEMO_DURATION = 90; // 1:30

function updateDemoTimer() {
  if (!demoRunning) return;
  const elapsed = (Date.now() - demoStartTime) / 1000;
  const pct = Math.min(100, (elapsed / DEMO_DURATION) * 100);
  const remaining = Math.max(0, DEMO_DURATION - elapsed);
  const mins = Math.floor(remaining / 60);
  const secs = Math.floor(remaining % 60);
  document.getElementById("demoTimerFill").style.width = pct + "%";
  document.getElementById("demoTimerText").textContent = `${mins}:${secs.toString().padStart(2,'0')} remaining`;
  if (demoRunning) requestAnimationFrame(updateDemoTimer);
}

function fireConfetti() {
  const colors = ['#836EF9','#F5C518','#4CC98A','#E84855','#fff'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.borderRadius = Math.random()>0.5?'50%':'2px';
    el.style.width = (6+Math.random()*8)+'px';
    el.style.height = (6+Math.random()*8)+'px';
    el.style.animationDuration = (2+Math.random()*2)+'s';
    el.style.animationDelay = (Math.random()*0.5)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 4000);
  }
}

function showStakeNotification(text) {
  const el = document.createElement('div');
  el.className = 'stake-notification';
  el.innerHTML = text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}

function unlockBadge(level) {
  const badges = document.querySelectorAll('.badge-item');
  badges.forEach(b => {
    const l = parseInt(b.dataset.level);
    if (l <= level) {
      b.classList.remove('locked');
      b.classList.add('unlocked','current');
      const icon = b.querySelector('.badge-icon');
      if (l===1) icon.textContent='üìã';
      if (l===2) icon.textContent='üèÜ';
      if (l===3) icon.textContent='üíé';
      if (l===4) icon.textContent='üëë';
    }
  });
}

async function startDemo() {
  if (demoRunning) return;
  demoRunning = true;
  demoStartTime = Date.now();
  document.getElementById("demoBtn").disabled = true;
  document.getElementById("demoBtn").textContent = "‚è≥ Demo running...";
  document.getElementById("demoTimer").classList.add("active");
  document.getElementById("chatMessages").innerHTML = "";
  updateDemoTimer();

  for (const step of demoScript) {
    if (step.type === "msg") {
      addMessage(step.who, step.text);
      await sleep(step.who==='ysa' ? 2200 : 1400);
    } else if (step.type === "data") {
      if (currentTab !== step.tab) switchTab(step.tab);
      await sleep(300);
      setCellValue(step.tab, step.row, step.col, step.val, step.fmt);
      await sleep(200);
    } else if (step.type === "progress") {
      setProgress(step.doc, step.pct);
      await sleep(100);
    } else if (step.type === "stake") {
      showStakeNotification(step.action==='show'
        ? '<div>üíé Staking...</div><div class="stake-amount">0.01 MON</div><div style="font-size:12px;color:#888;margin-top:4px;">7-day discipline challenge</div>'
        : '<div>‚úÖ Stake confirmed</div><div class="stake-amount">0.01 MON</div><div style="font-size:12px;color:#4CC98A;margin-top:4px;">Challenge active ‚Äî 7 days</div>');
      document.getElementById("cycleBadge").textContent = step.action==='confirmed' ? "Day 1/7 ‚è≥" : "Staking...";
      if (step.action==='confirmed') document.getElementById("cycleBadge").classList.add("active");
      await sleep(2000);
    } else if (step.type === "badge") {
      unlockBadge(step.level);
      await sleep(800);
    } else if (step.type === "confetti") {
      fireConfetti();
      await sleep(1500);
    }
  }
  document.getElementById("demoBtn").textContent = "‚úÖ Demo complete";
  document.getElementById("demoTimerFill").style.width = "100%";
  document.getElementById("demoTimerText").textContent = "Complete!";
  demoRunning = false;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============ INIT ============
renderSheet("pl");
renderQuiz();
// Auto-start demo after 1.5s
setTimeout(() => startDemo(), 1500);
</script>
</body>
</html>
